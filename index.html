<!-- version w/o pointerlock controls
implemented threex and linkify. linkify changed to use dblclick
cleaned up code
-->
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>AntHillHacks</title>
		<link rel="stylesheet" href="js/avgrund_modal/avgrund.css">
		<link rel="stylesheet" href="css/bootstrap/css/bootstrap.css">
		<link rel="stylesheet" href="css/lightbox.css">
		<style>
			html, body {
				width: 100%;
				height: 100%;
			}

			body {
				background-color: #ffffff;
				margin: 0;
				overflow: hidden;
				font-family: arial;
			}


			#blocker {

				position: absolute;

				width: 100%;
				height: 100%;

				background-color: rgba(0,0,0,0.5);

			}

			#instructions {

				width: 100%;
				height: 100%;

				display: -webkit-box;
				display: -moz-box;
				display: box;

				-webkit-box-orient: horizontal;
				-moz-box-orient: horizontal;
				box-orient: horizontal;

				-webkit-box-pack: center;
				-moz-box-pack: center;
				box-pack: center;

				-webkit-box-align: center;
				-moz-box-align: center;
				box-align: center;

				color: #ffffff;
				text-align: center;

				cursor: pointer;

			}
			#top_view {
				z-index: 50;
				   position:absolute;
					top: 46%;
					left: 48%;


			}
            #swt-container{
                margin-top: -60vh;
                height: 50vh;
                position: fixed;
                overflow-y: auto;
                overflow-x:hidden;
                z-index: 100;
                transition: all .4s ease 0s;
                background: #fff;
            }
            #swt-overlay {
                z-index: 100;
            }
            #swt-overlay.active #swt-container {
                top: 70vh;
            }

		</style>
	</head>
	<body>


		<script src="js/three.min.js"></script>
		<script src="js/OrbitControls.js"></script>
		<script src="js/Projector.js"></script>
		<script src="js/fonts/helvetiker_regular.typeface.js"></script>
		<script src="js/fonts/gentilis_regular.typeface.js"></script>
		<script src="js/jquery-1.11.3.min.js"></script>
		<script src="js/underscore-min.js"></script>
		<script src="js/backbone-min.js"></script>
		<script src="css/bootstrap/js/bootstrap.js"></script>
        <script src="js/lightbox.js"></script>
		<script src="js/avgrund_modal/jquery.avgrund.js"></script>
		<script src ="js/threex.domevents.js"></script>
		<SCRIPT SRC ="js/threex.linkify.js"></SCRIPT>
<div class="buttons">

			<p>Fast Navigation: <a href="#" id="tb_link">Traveller's Bungalow</a> <a href="#" id="ant_link">Anteras</a> <a href="#" id="kalyani_link">Idol at Kalyani</a></p>
			</div>
<div id ="show2" > </div>
<div id ="show3" > </div>
<div class="container-fluid active" id ="swt-overlay">
        <div id="swt-container">
        </div>
        <button type="button" class="btn btn-default close-swt">X</button>
</div>



		

        <!-- Templates for web components -->
        <script type="text/template" id="swts-template">
<div class="swtr-web col-md-4 col-lg-4">
<div class="panel panel-default">
<div class="panel-body">
<% if(what == "img-anno") {%>
<div class="media">
<a class="lightbox-item" href="<%=where%>" data-lightbox="<%=what%>"
data-title="<%=how.comment%> <%=how.tags%>">
<img class="media-object img-responsive" src="<%=where%>"  />
</a>
</div>
<div class="panel-footer">
<h4 class="panel-heading"> <%=how.title%></h4>
<h5> <%=how.comment%></h5>
<p>-<%=who%> on <%=created%> tagged <%=how.tags%> </p>
</div>
<%}%>
<%if ( what == "audio-tagger") {%>
 <audio controls="controls" preload="none"  >
                   Your browser does not support the <code>audio</code>
                   element.
      <source src="<%=where%>">
                                                                                                                                 >
                                                                                                                                                 </audio>
<div class="panel-footer">
<p>-<%=who%> on <%=created%> tagged <%=how.tags%> </p>
</div>
<%}%>
</div>
</div>
</div>
        </script>

		<script>
		
		$('#tb_link').click(function(){
			
			controls.getObject().position.set(5923.517712446898,-320.5704149116684, 3206.7164017965843);
			controls.getObject().rotation.set(0,-2.5009, 0);
			
			});
		
		$('#ant_link').click(function(){
			
			controls.getObject().position.set( 6687.459775821677, -653.7992265627007, 309.5418206014522);
			controls.getObject().rotation.set(0,-3.752, 0);
			
			});
		
		$('#kalyani_link').click(function(){
			
			controls.getObject().position.set(3277.680627965646,  -1120.0994513791368, -519.675566336317);
			controls.getObject().rotation.set(0,-8.404, 0);
			
			});
		
		// Swts from swt store
		var swt = Backbone.Model.extend({
		defaults: { 'who' :'',
		'what' : '',
		'where' : '',
		'how' : {}
		}	
		});


var swtsCollection = Backbone.Collection.extend({
    model: swt,
    filterByTag: function(tag) {
        var swts = this.filter(function(model){
            if(_.contains(model.get('how').tags, tag)){
                return model;
            }
        });  
        return swts = _.uniq(swts, function(swt){
            return swt.get('where');
        });
    }      
});
var txtAnno = new swtsCollection();
txtAnno.fetch({url:
    'http://thestore.swtr.in/api/sweets/q?what=txt-anno'});
var audioAnno = new swtsCollection();
audioAnno.fetch({url:
    'http://thestore.swtr.in/api/sweets/q?what=audio-tagger'});
swts = new swtsCollection();
swts.fetch({url:'http://thestore.swtr.in/api/sweets/q?what=img-anno',
    success: function(swts, response){
        swts.add(txtAnno.models);
        swts.add(audioAnno.models);
        init();
        animate();
    }
});
console.log(swts);
//swts view to handle click handlers
var swtsView = Backbone.View.extend({
    el: "#swt-overlay",
    events:{
        ".close-swt click": "closeSwtOverlay"
    },
    initialize: function(options){
        this.$swtContainer = $("#swt-container");
        $(".close-swt").click(function(e) {
            e.preventDefault();
            $("#swt-overlay").toggleClass("active");

        });
        this.render();
        this.listenTo(this.collection, "set", this.render);
        console.log(swts, "uniq swts");
    },
    template: _.template($('#swts-template').html()),
    render: function() {
        this.$swtContainer.html('');
        //this.targetId = this.collection.get(options.id);
        _.each(this.collection, function(model) {
            this.$swtContainer.append(this.template(model.toJSON()));
        }, this);

    },
    closeSwtOverlay: function(event) {
        console.log(event);
        if(!(this.$el.is(":hidden"))){
            this.$el.hide();
        }
        else {
            this.$el.show();
        }
    }
});

// Supposed backbone views to render canvas - status: Incomplete
/*var boxView = Backbone.View.extend({
    tagName: 'canvas',
    initialize: function(options) {    
        this.model = options.model;
		this.temp = new Image();
		this.temp.src = 'images/temp.png';
    },
    render: function(){
		canvas.width = 256;
		canvas.height = 128;
		context = canvas.getContext('2d');
        this.temp.onload = function() {
            context.drawImage(this.temp, 0, 0, 256, 128);
            context.font = 'Bold 15px Helvetica';
            context.fillStyle ="#ff0000";
            context.fillText(this.model.get('who'), 60, 30);
            context.fillText(this.model.get('how').title, 20, 64);
            context.fillText(this.model.get('how').tags, 20, 110);
            context.font = 'Bold 10px Helvetica';
            context.fillText(this.model.get('how').comment, 20, 90);
        }
        console.log(this.temp);

    }
});
var annoView = Backbone.View.extend({
    initialize: function() {
        this.collection = new swts();
        this.collection.fetch({url:'http://thestore.swtr.in/api/sweets/q?what=img-anno'});
    },
    render: function(){
        this.collection.each(function(model) {
            var box = new boxView({model: model});
        });
    }
});
*/			
	
			//variables	
			var camera, scene, renderer;
			var controls, controls2;
			var objects = [];
			var raycaster, raycaster2, mouse;
			var murra, cube, cube2, camera2;
			var raycaster2 = new THREE.Raycaster();
			var direction = new THREE.Vector3( 0, 0, 0.5 );
			var rotation = new THREE.Euler( 0, 0, 0, "YXZ" );
			var v3 = new THREE.Vector3;
			var info_tex, info_geo, info_mat, info_icon;
			var audio_tex, audio_geo, audio_mat, audio_icon, terrain_map;
			var colorize = 0, ji = 0;
			var mClick = 0;
			var sweet = [], sweet_geo = [], sweet_mat = [], canvas = [], context =[], img2 = [], texture12 = [], who = [], what = [], where = [], id = [], created = [], title = [], tags = [],temp = [], comment = [];
			var intersects2;
			var intersections2;
			var mesh, mesh2;
			var filteredsweet = [];
			var group1, group2;
			var domEvents;
			
			function init() {
				
				//render code
				renderer = new THREE.WebGLRenderer({antialias: true});
				renderer.setClearColor( 0x333377, 0.9 );
				renderer.autoClear = false;
				//renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				
				scene = new THREE.Scene();
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 500000 );
				scene.add(camera);
				camera.position.set(6408, -721, 576 )
				
				//controls
				controls = new THREE.OrbitControls(camera, renderer.domElement);
				controls.noPan = true;
				controls.noZoom = false;
				controls.center.set(camera.position.x-0.1, camera.position.y, camera.position.z);
				
				//lights
				/*
				var light1 = new THREE.PointLight( 0xeeeeff, 100, 500 );
				light1.position.set( 200,230,-50 );
				scene.add( light1 );
			
				var light2 = new THREE.PointLight( 0xeeeeff, 100, 500 );
				light2.position.set( 20,20,-250 );
				scene.add( light2 );
			
				var light = new THREE.HemisphereLight( 0xeeeeff, 0x777788, 0.75 );
				light.position.set( 0.5, 1, 0.75 );
				scene.add( light );
				*/
				
				
				 //dom events
				 domEvents = new THREEx.DomEvents(camera, renderer.domElement);
				document.addEventListener( 'keydown', onKeyDown, false );
				//document.addEventListener( 'keyup', onKeyUp, false );
				//document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				//document.addEventListener( 'mouseover', onDocumentMouseOver, false );
				//document.addEventListener( 'mouseout', onDocumentMouseOut, false );
				window.addEventListener( 'resize', onWindowResize, false );
				raycaster = new THREE.Raycaster( new THREE.Vector3(), new THREE.Vector3( 0, - 1, 0 ), 0, 1000 );
				mouse = new THREE.Vector2();
				

		//objects
                
               
               //json
		var loader = new THREE.JSONLoader();
		tex2 = new THREE.ImageUtils.loadTexture('objects/tb_drone2/meshAvImgCol_color.png');
		loader.load( "objects/tb_drone2/itbdron3.1.js", function( geometry, material ) {
		geometry.center();
		var scale = 5;
	        drone_mesh = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial({map:tex2, side:THREE.DoubleSide})  );
		drone_mesh.rotation.set(3.1, -3.90, 0);
		drone_mesh.scale.set(scale,scale,scale);
		scene.add(drone_mesh);
		drone_mesh.position.set( 5909, -355,  3293);
		});
                
		var loader3 = new THREE.JSONLoader();
		tex4 = new THREE.ImageUtils.loadTexture('objects/idol/meshAvImgCol_color.png');
		loader3.load( "objects/idol/idolsimple.js", function( geometry, material ) {
		geometry.center();
		var scale = 10;
		idol_mesh = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial({map:tex4, side:THREE.DoubleSide})  );
		idol_mesh.rotation.set(-3.0999, 1.4999, 0);
		idol_mesh.scale.set(scale,scale,scale);
		scene.add(idol_mesh);
		idol_mesh.position.set(3375.4281241, -1160, -331.91);
		});
		
		var loader4 = new THREE.JSONLoader();
		var tex5 = new THREE.ImageUtils.loadTexture('objects/ddhills_terrain_3/0_test1_0_2.png');
		tex5.generateMipmaps = false;
	        tex5.minFilter = THREE.LinearFilter;
	        tex5.magFilter = THREE.LinearFilter;
		loader4.load( "objects/ddhills_terrain_3/0_test1_4.js", function( geometry, material) {
		geometry.center();
		var scale = 100;
		terrain_map = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial({ map: tex5, side:THREE.DoubleSide})  );
		terrain_map.scale.set(scale,scale,scale);
		scene.add(terrain_map);
		terrain_map.position.set(0,-1360,0);
		//threex event handler
		domEvents.addEventListener(terrain_map, 'click', function(event){
		console.log("eh?");					
		}, false);
		});
		
		
		//skybox
		var skybox = new THREE.Mesh(new THREE.SphereGeometry(100000,75,75), new THREE.MeshBasicMaterial({map: new THREE.ImageUtils.loadTexture('images/sky1.jpg'), side:THREE.BackSide}));
		scene.add(skybox);
		skybox.position.set(0,-4360 , 0);
		
                //test cube
		cube = new THREE.Mesh(new THREE.BoxGeometry(200,500,200), new THREE.MeshBasicMaterial({side:THREE.DoubleSide, color:0x00ff00}));
		scene.add(cube);
		cube.name = 'cube1';
		cube.position.set(6008, -721, 576 );
		
		
		makeSweets("Maharashtra");
		makeSweets("Goa");
	 
		//audio icon
		/*
	       audio_tex = new THREE.ImageUtils.loadTexture('images/audio.png');
	       audio_tex.generateMipmaps = false;
	       audio_tex.minFilter = THREE.LinearFilter;
	       audio_tex.magFilter = THREE.LinearFilter;
               audio_geo = new THREE.PlaneBufferGeometry(35, 35);
               audio_mat = new THREE.MeshBasicMaterial ({map:audio_tex, transparent:true, opacity:0.9});
               audio_icon = new THREE.Mesh(audio_geo, audio_mat);
               scene.add(audio_icon);
	       audio_icon.position.set(6551.9908097, -724.341328, 493.19269);
	       audio_icon.name = 'tb_audio';
		*/
          
                }
			
	function makeSweets(x) {
		//generates a canvas texture with sweet data, textures onto mesh;
		//using window[] to declare global variables. find more efficient way.
		filteredsweet = swts.filterByTag(x);
		
		var temps = [];
		var  who = [], what = [], where = [], id = [], created = [], title = [], tags = [], comment = [];
		window[x+'ID'] = [];
		window[x+'Canvas'] = [];
		window[x+'Context'] = [];
		window['sweet'+x] = [];
		window[x+'Texture'] = [];
		window[x+'Mat'] = [];
		window[x+'Geo'] = [];
		window[x+'Length'] = filteredsweet.length;
		window[x+'Url'] = [];
		window[x+'Linkify'] = [];
		
		
		for(var i=0; i<filteredsweet.length; i++)
		{
		var swt = filteredsweet[i].toJSON();
		//console.log(swt);
		window[x+'ID'][i] = swt.id;
		//swtsWebView = new swtsView({collection: filteredsweet, id:swt.id});
		who[i] = swt.who;
		if (!("title" in swt.how)) {
			title[i] = 'NO TITLE';
		}
		else {
			title[i] = swt.how.title;
		}
		
		if (!("comment" in swt.how)) {
			comment[i] = 'NO comment';
		}
		else {
			comment[i] = swt.how.comment;
		}
		
		if (!("tags" in swt.how)) {
			tags[i] = 'NO tags';
		}
		
		else {
			
			tags[i] = '';
			for(var l=0; l<swt.how.tags.length;l++)
			{
				
			tags[i]+= swt.how.tags[l]+' '; 
			}
		//console.log('who='+who[i], 'title='+title[i],
		//'comment='+comment[i], 'tags='+tags[i])
	
		}
		
			
		// create canvas
		window[x+'Canvas'][i] = document.createElement('canvas');
		window[x+'Canvas'][i].width = 256;
		window[x+'Canvas'][i].height = 128;
		window[x+'Context'][i] = window[x+'Canvas'][i].getContext('2d');
		var temp = new Image();
		temp.onload = (function(i){
			return function() {
						
						window[x+'Context'][i].drawImage(temp, 0, 0, 256, 128);
						window[x+'Context'][i].font = 'Regular 15px Helvetica';
						window[x+'Context'][i].fillStyle ="#000000";
						window[x+'Context'][i].fillText(who[i], 60, 30);
						window[x+'Context'][i].fillText(title[i], 20, 64);
						window[x+'Context'][i].fillText(tags[i], 20, 110);
						window[x+'Context'][i].font = 'Regular 10px Helvetica';
						window[x+'Context'][i].fillText(comment[i], 20, 90);
						
			}
		})(i);
		temp.src = 'images/template2.jpg';
		window[x+'Texture'][i] = new THREE.Texture(window[x+'Canvas'][i]);
		window[x+'Texture'][i].needsUpdate = true;
		window[x+'Geo'][i] = new THREE.BoxGeometry(70, 35, 1);
                window[x+'Mat'][i] = new THREE.MeshBasicMaterial ({map:window[x+'Texture'][i]});
		window['sweet'+x][i] =  new THREE.Mesh(window[x+'Geo'][i], window[x+'Mat'][i]);
		scene.add(window['sweet'+x][i]);
	        window[x+'Url'][i] = 'http://thestore.swtr.in/sweets/'+window[x+'ID'][i]
		window[x+'Linkify'][i] = THREEx.Linkify(domEvents, window['sweet'+x][i], window[x+'Url'][i], true)
		
		switch (x){
		
		case "Goa":
				window['sweet'+x][i].position.set(Math.random() * (6500 - 6100) + 6100, - 700, Math.random() * (1000 - 700) + 700);
				window['sweet'+x][i].name = 'Goa'+i;
				break;
		
		case "Maharashtra":
				window['sweet'+x][i].position.set(Math.random() * (370-236) + 236,  1000, Math.random() * (6968 - 6101) + 6101);
				window['sweet'+x][i].name = 'Maharashtra'+i;
				break;
			}
		}
	       };

	function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );

		};
			
	function makeRay(event) {
				
				raycaster2 = new THREE.Raycaster(controls.getObject().position, controls.getDirection(v3), 0, 1000);
				return raycaster2;
		};
			
	function onKeyDown( event ) {
				var value=0.01, value2 =1;
				switch ( event.keyCode ) {
				//add navigation code here
						case 38: // up
						case 87: // w
							moveForward = true;
							break;

						case 37: // left
						case 65: // a
							moveLeft = true; break;

						case 40: // down
						case 83: // s
							moveBackward = true;
							break;

						case 39: // right
						case 68: // d
							moveRight = true;
							break;
						case 81: //q
							moveUp = true;
							break;
						
						case 69: //e
							moveDown = true;
							break;

						
						}

				};

				
			function onDocumentMouseDown( event ) {
				//might not be required
				event.preventDefault();

				mouse.x = ( event.clientX / renderer.domElement.width ) * 2 - 1;
				mouse.y = - ( event.clientY / renderer.domElement.height ) * 2 + 1;
				
				
					
					var intersected;
					var ray = makeRay(event);
					if (ray.intersectObjects(scene.children).length > 0)
					{	
						intersected = ray.intersectObjects(scene.children);
						//console.log(intersected);
						for (i = 0; i < intersected.length; i++)
						{
							console.log(intersected[i]);
							mClick++;
							console.log(mClick);
							
								for(j=0; j<GoaLength; j++)
								{
									if (intersected[i].object.name === 'Goa'+j) {
										console.log('Goa'+j);
									}
								}
								for(j=0; j<MaharashtraLength; j++)
								{
									if (intersected[i].object.name === 'Maharashtra'+j) {
										console.log('Maharashtra'+j);
									}
								}



			}}}
			
		function animate() {

			requestAnimationFrame( animate );
			render();
			controls.update();
		
			for(var i=0; i<GoaLength; i++)
			{	
				sweetGoa[i].lookAt(camera.position);
				GoaTexture[i].needsUpdate = true;
			};
			
			for(var i=0; i<MaharashtraLength; i++)
			{
				sweetMaharashtra[i].lookAt(camera.position);
				MaharashtraTexture[i].needsUpdate = true;
			};
			}
			
		function render() {
		
			renderer.setClearColor( 0x333377 );
			renderer.render( scene, camera );
	
			}

		</script>
	</body>
</html>
